function addClassName(e,t){var n=e.className;return n.length>0&&(n===t||new RegExp("(^|\\s)"+t+"(\\s|$)").test(n))||(e.className=e.className+(e.className?" ":"")+t),e}function addEvent(e,t,n,r){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n,!1),r&&"function"==typeof r.push?r.push({element:e,event:t,callback:n}):eventCache.push({element:e,event:t,callback:n})}function extend(e,t){t=t||{},e=e||{};var n;for(n in t)t.hasOwnProperty(n)&&"undefined"!=typeof t[n]&&(e[n]=t[n]);return e}function extendRegExp(e,t,n){var r,a=e.toString(),o="";return(null===t||void 0===t)&&(t=""),(null===n||void 0===n)&&(n=""),r=a.match(/\/([gim]*)$/),o=r?r[1]:"",a=a.replace(/(^\/|\/[gim]*$)/g,""),a=t+a+n,new RegExp(a,o)}function fixEol(e){return(e||"").replace(/\r\n/g,"\n").replace(/\r/g,"\n")}function getViewportDimensions(){return documentElement||(documentElement=browser.WebKit&&!document.evaluate?document:browser.Opera&&window.parseFloat(window.opera.version())<9.5?document.body:document.documentElement),{width:documentElement.clientWidth,height:documentElement.clientHeight}}function indexOf(e,t){var n,r;if(e){if("undefined"!=typeof e.indexOf)return e.indexOf(t);if("undefined"!=typeof e.length)for(n=0,r=e.length;r>n;n++)if(e[n]===t)return n}return-1}function randomString(e,t){function n(){return s.charAt(r(0,s.length))}function r(e,t){return Math.floor(Math.random()*(t-e))+e}t=extend({numbers:!1,lower:!0,upper:!0,other:!1},t);var a="0123456789",o="abcdefjhijklmnopqrstuvwxyz",l="ABCDEFJHIJKLMNOPQRSTUVWXYZ",i="`~!@#$%^&*()-_=+[{]}\\|;:'\",<.>/?",s="",c="";if(t.numbers&&(s+=a),t.lower&&(s+=o),t.upper&&(s+=l),t.other&&(s+=i),0===s.length)throw"There is no character set from which to generate random strings.";for(var u=0;e>u;u++)c+=n();return c}function removeClassName(e,t){return e.className=e.className.replace(new RegExp("(^|\\s+)"+t+"(\\s+|$)")," ").replace(/^\s+/,"").replace(/\s+$/,""),e}function removeEvent(e,t,n,r){var a=null,o=0;for(r=r&&"function"==typeof r.push?r:eventCache;o<r.length;o++)if(r[o].element===e&&r[o].event===t&&r[o].callback===n){a=r[o];break}e.detachEvent?e.detachEvent("on"+t,n):e.removeEventListener(t,n,!1),a&&r.splice(indexOf(r,a),1)}function visible(e){var t=!0;return window.getComputedStyle?t="none"!==window.getComputedStyle(e,null).getPropertyValue("display"):e.currentStyle&&(t="none"!==e.currentStyle.display),t}function chooseTranslator(e){Translator="RU"==e?Translator_RU:Translator_EN,Command.builtIn={strong:{text:Translator.strongText,title:Translator.strongTitle,css:"wmd-strong",shortcut:"b"},em:{text:Translator.emText,title:Translator.emTitle,css:"wmd-em",shortcut:"i"},a:{text:Translator.aText,title:Translator.aTitle,css:"wmd-a",shortcut:"l"},blockquote:{text:Translator.blockquoteText,title:Translator.blockquoteTitle,css:"wmd-blockquote",shortcut:"q"},code:{text:Translator.codeText,title:Translator.codeTitle,css:"wmd-code",shortcut:"k"},img:{text:Translator.imgText,title:Translator.imgTitle,css:"wmd-img",shortcut:"g"},ol:{text:Translator.olText,title:Translator.olTitle,css:"wmd-ol",shortcut:"o"},ul:{text:Translator.ulText,title:Translator.ulTitle,css:"wmd-ul",shortcut:"u"},h:{text:Translator.hText,title:Translator.hTitle,css:"wmd-h",shortcut:"h"},hr:{text:Translator.hrText,title:Translator.hrTitle,css:"wmd-hr",shortcut:"r"},spacer:{css:"wmd-spacer",builder:Command.createSpacer}}}var Attacklab=Attacklab||{};Attacklab.showdown=Attacklab.showdown||{},Attacklab.showdown.converter=function(){var e,t,n,r=0;this.makeHtml=function(r){return e=new Array,t=new Array,n=new Array,r=r.replace(/~/g,"~T"),r=r.replace(/\$/g,"~D"),r=r.replace(/\r\n/g,"\n"),r=r.replace(/\r/g,"\n"),r="\n\n"+r+"\n\n",r=N(r),r=r.replace(/^[ \t]+$/gm,""),r=l(r),r=o(r),r=s(r),r=S(r),r=r.replace(/~D/g,"$$"),r=r.replace(/~T/g,"~")};var a,o=function(n){var n=n.replace(/^[ ]{0,3}\[(.+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+)/gm,function(n,r,a,o,l){return r=r.toLowerCase(),e[r]=k(a),o?o+l:(l&&(t[r]=l.replace(/"/g,"&quot;")),"")});return n},l=function(e){e=e.replace(/\n/g,"\n\n");return e=e.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math|ins|del)\b[^\r]*?\n<\/\2>[ \t]*(?=\n+))/gm,i),e=e.replace(/^(<(p|div|h[1-6]|blockquote|pre|table|dl|ol|ul|script|noscript|form|fieldset|iframe|math)\b[^\r]*?.*<\/\2>[ \t]*(?=\n+)\n)/gm,i),e=e.replace(/(\n[ ]{0,3}(<(hr)\b([^<>])*?\/?>)[ \t]*(?=\n{2,}))/g,i),e=e.replace(/(\n\n[ ]{0,3}<!(--[^\r]*?--\s*)+>[ \t]*(?=\n{2,}))/g,i),e=e.replace(/(?:\n\n)([ ]{0,3}(?:<([?%])[^\r]*?\2>)[ \t]*(?=\n{2,}))/g,i),e=e.replace(/\n\n/g,"\n")},i=function(e,t){var r=t;return r=r.replace(/\n\n/g,"\n"),r=r.replace(/^\n/,""),r=r.replace(/\n+$/g,""),r="\n\n~K"+(n.push(r)-1)+"K\n\n"},s=function(e){e=g(e);var t=T("<hr />");return e=e.replace(/^[ ]{0,2}([ ]?\*[ ]?){3,}[ \t]*$/gm,t),e=e.replace(/^[ ]{0,2}([ ]?-[ ]?){3,}[ \t]*$/gm,t),e=e.replace(/^[ ]{0,2}([ ]?_[ ]?){3,}[ \t]*$/gm,t),e=h(e),e=v(e),e=y(e),e=l(e),e=C(e)},c=function(e){return e=b(e),e=u(e),e=E(e),e=p(e),e=d(e),e=$(e),e=k(e),e=x(e),e=e.replace(/\n/g," <br>\n")},u=function(e){var t=/(<[a-z\/!$]("[^"]*"|'[^']*'|[^'">])*>|<!(--.*?--\s*)+>)/gi;return e=e.replace(t,function(e){var t=e.replace(/(.)<\/?code>(?=.)/g,"$1`");return t=R(t,"\\`*_")})},d=function(e){return e=e.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,f),e=e.replace(/(\[((?:\[[^\]]*\]|[^\[\]])*)\]\([ \t]*()<?(.*?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,f),e=e.replace(/(\[([^\[\]]+)\])()()()()()/g,f)},f=function(n,r,a,o,l,i,s,c){void 0==c&&(c="");var u=r,d=a,f=o.toLowerCase(),p=l,m=c;if(""==p)if(""==f&&(f=d.toLowerCase().replace(/ ?\n/g," ")),p="#"+f,void 0!=e[f])p=e[f],void 0!=t[f]&&(m=t[f]);else{if(!(u.search(/\(\s*\)$/m)>-1))return u;p=""}p=R(p,"*_");var g='<a href="'+p+'"';return""!=m&&(m=m.replace(/"/g,"&quot;"),m=R(m,"*_"),g+=' title="'+m+'"'),g+=">"+d+"</a>"},p=function(e){return e=e.replace(/(!\[(.*?)\][ ]?(?:\n[ ]*)?\[(.*?)\])()()()()/g,m),e=e.replace(/(!\[(.*?)\]\s?\([ \t]*()<?(\S+?)>?[ \t]*((['"])(.*?)\6[ \t]*)?\))/g,m)},m=function(n,r,a,o,l,i,s,c){var u=r,d=a,f=o.toLowerCase(),p=l,m=c;if(m||(m=""),""==p){if(""==f&&(f=d.toLowerCase().replace(/ ?\n/g," ")),p="#"+f,void 0==e[f])return u;p=e[f],void 0!=t[f]&&(m=t[f])}d=d.replace(/"/g,"&quot;"),p=R(p,"*_");var g='<img src="'+p+'" alt="'+d+'"';return m=m.replace(/"/g,"&quot;"),m=R(m,"*_"),g+=' title="'+m+'"',g+=" />"},g=function(e){return e=e.replace(/^(.+)[ \t]*\n=+[ \t]*\n+/gm,function(e,t){return T("<h1>"+c(t)+"</h1>")}),e=e.replace(/^(.+)[ \t]*\n-+[ \t]*\n+/gm,function(e,t){return T("<h2>"+c(t)+"</h2>")}),e=e.replace(/^(\#{1,6})[ \t]*(.+?)[ \t]*\#*\n+/gm,function(e,t,n){var r=t.length;return T("<h"+r+">"+c(n)+"</h"+r+">")})},h=function(e){e+="~0";var t=/^(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/gm;return r?e=e.replace(t,function(e,t,n){var r=t,o=n.search(/[*+-]/g)>-1?"ul":"ol";r=r.replace(/\n{2,}/g,"\n\n\n");var l=a(r);return l=l.replace(/\s+$/,""),l="<"+o+">"+l+"</"+o+">\n"}):(t=/(\n\n|^\n?)(([ ]{0,3}([*+-]|\d+[.])[ \t]+)[^\r]+?(~0|\n{2,}(?=\S)(?![ \t]*(?:[*+-]|\d+[.])[ \t]+)))/g,e=e.replace(t,function(e,t,n,r){var o=t,l=n,i=r.search(/[*+-]/g)>-1?"ul":"ol",l=l.replace(/\n{2,}/g,"\n\n\n"),s=a(l);return s=o+"<"+i+">\n"+s+"</"+i+">\n"})),e=e.replace(/~0/,"")};a=function(e){return r++,e=e.replace(/\n{2,}$/,"\n"),e+="~0",e=e.replace(/(\n)?(^[ \t]*)([*+-]|\d+[.])[ \t]+([^\r]+?(\n{1,2}))(?=\n*(~0|\2([*+-]|\d+[.])[ \t]+))/gm,function(e,t,n,r,a){var o=a,l=t;return l||o.search(/\n{2,}/)>-1?o=s(I(o)):(o=h(I(o)),o=o.replace(/\n$/,""),o=c(o)),"<li>"+o+"</li>\n"}),e=e.replace(/~0/g,""),r--,e};var v=function(e){return e+="~0",e=e.replace(/(?:\n\n|^)((?:(?:[ ]{4}|\t).*\n+)+)(\n*[ ]{0,3}[^ \t\n]|(?=~0))/g,function(e,t,n){var r=t,a=n;return r=w(I(r)),r=N(r),r=r.replace(/^\n+/g,""),r=r.replace(/\n+$/g,""),r="<pre><code class='highlight'>"+r+"\n</code></pre>",T(r)+a}),e=e.replace(/~0/,"")},T=function(e){return e=e.replace(/(^\n+|\n+$)/g,""),"\n\n~K"+(n.push(e)-1)+"K\n\n"},b=function(e){return e=e.replace(/(^|[^\\])(`+)([^\r]*?[^`])\2(?!`)/gm,function(e,t,n,r){var a=r;return a=a.replace(/^([ \t]*)/g,""),a=a.replace(/[ \t]*$/g,""),a=w(a),t+"<code class='highlight'>"+a+"</code>"})},w=function(e){return e=e.replace(/&/g,"&amp;"),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e=R(e,"*_{}[]\\",!1)},x=function(e){return e=e.replace(/(\*\*|__)(?=\S)([^\r]*?\S[\*_]*)\1/g,"<strong>$2</strong>"),e=e.replace(/(\*|_)(?=\S)([^\r]*?\S)\1/g,"<em>$2</em>")},y=function(e){return e=e.replace(/((^[ \t]*>[ \t]?.+\n(.+\n)*\n*)+)/gm,function(e,t){var n=t;return n=n.replace(/^[ \t]*>[ \t]?/gm,"~0"),n=n.replace(/~0/g,""),n=n.replace(/^[ \t]+$/gm,""),n=s(n),n=n.replace(/(^|\n)/g,"$1  "),n=n.replace(/(\s*<pre>[^\r]+?<\/pre>)/gm,function(e,t){var n=t;return n=n.replace(/^  /gm,"~0"),n=n.replace(/~0/g,"")}),T("<blockquote>\n"+n+"\n</blockquote>")})},C=function(e){e=e.replace(/^\n+/g,""),e=e.replace(/\n+$/g,"");for(var t=e.split(/\n{2,}/g),r=new Array,a=t.length,o=0;a>o;o++){var l=t[o];l.search(/~K(\d+)K/g)>=0?r.push(l):l.search(/\S/)>=0&&(l=c(l),l=l.replace(/^([ \t]*)/g,"<p>"),l+="</p>",r.push(l))}a=r.length;for(var o=0;a>o;o++)for(;r[o].search(/~K(\d+)K/)>=0;){var i=n[RegExp.$1];i=i.replace(/\$/g,"$$$$"),r[o]=r[o].replace(/~K\d+K/,i)}return r.join("\n\n")},k=function(e){return e=e.replace(/&(?!#?[xX]?(?:[0-9a-fA-F]+|\w+);)/g,"&amp;"),e=e.replace(/<(?![a-z\/?\$!])/gi,"&lt;")},E=function(e){return e=e.replace(/\\(\\)/g,F),e=e.replace(/\\([`*_{}\[\]()>#+-.!])/g,F)},$=function(e){return e=e.replace(/<((https?|ftp|dict):[^'">\s]+)>/gi,'<a href="$1">$1</a>'),e=e.replace(/<(?:mailto:)?([-.\w]+\@[-a-z0-9]+(\.[-a-z0-9]+)*\.[a-z]+)>/gi,function(e,t){return L(S(t))})},L=function(e){function t(e){var t="0123456789ABCDEF",n=e.charCodeAt(0);return t.charAt(n>>4)+t.charAt(15&n)}var n=[function(e){return"&#"+e.charCodeAt(0)+";"},function(e){return"&#x"+t(e)+";"},function(e){return e}];return e="mailto:"+e,e=e.replace(/./g,function(e){if("@"==e)e=n[Math.floor(2*Math.random())](e);else if(":"!=e){var t=Math.random();e=t>.9?n[2](e):t>.45?n[1](e):n[0](e)}return e}),e='<a href="'+e+'">'+e+"</a>",e=e.replace(/">.+:/g,'">')},S=function(e){return e=e.replace(/~E(\d+)E/g,function(e,t){var n=parseInt(t);return String.fromCharCode(n)})},I=function(e){return e=e.replace(/^(\t|[ ]{1,4})/gm,"~0"),e=e.replace(/~0/g,"")},N=function(e){return e=e.replace(/\t(?=\t)/g,"    "),e=e.replace(/\t/g,"~A~B"),e=e.replace(/~B(.+?)~A/g,function(e,t){for(var n=t,r=4-n.length%4,a=0;r>a;a++)n+=" ";return n}),e=e.replace(/~A/g,"    "),e=e.replace(/~B/g,"")},R=function(e,t,n){var r="(["+t.replace(/([\[\]\\])/g,"\\$1")+"])";n&&(r="\\\\"+r);var a=new RegExp(r,"g");return e=e.replace(a,F)},F=function(e,t){var n=t.charCodeAt(0);return"~E"+n+"E"}};var Showdown=Attacklab.showdown;Attacklab.fileLoaded&&Attacklab.fileLoaded("showdown.js");var WMD,Chunk,InputState,Command,Dialog,Overlay,Form,Field,LinkHelper,Translator,documentElement,eventCache=[],browser={IE:!(!window.attachEvent||window.opera),Opera:!!window.opera,WebKit:navigator.userAgent.indexOf("AppleWebKit/")>-1};WMD=function(e,t,n){function r(){var e,r,a,o,s,c,u=n.commands.split(" ");if(t)for(t.innerHTML="",e=document.createElement("ul"),e.className="wmd-toolbar",t.appendChild(e),r=0;r<u.length;r+=1)a=u[r],o=null,c=null,s=Command.create,n.commandTable[a]?o=n.commandTable[a]:Command.builtIn[a]&&(o=Command.builtIn[a]),o&&(o.builder&&"function"==typeof o.builder&&(s=o.builder),c=s(l,a,o),o.shortcut&&"string"==typeof o.shortcut&&(i[o.shortcut.toLowerCase()]=c.run),c.draw(e))}function a(){function t(){e.value!==s&&(n.preview.innerHTML=n.showdown(e.value),s=e.value)}addEvent(e,browser.Opera?"keypress":"keydown",function(e){var t=e||window.event,n=t.keyCode||t.which,r=String.fromCharCode(n).toLowerCase();if((t.ctrlKey||t.metaKey)&&i[r]&&"function"==typeof i[r])return i[r](),t.preventDefault&&t.preventDefault(),window.event&&(window.event.returnValue=!1),!1;if(9===n){var a;return a=this.selectionStart+"    ".length,this.value=this.value.substring(0,this.selectionStart)+"    "+this.value.substring(this.selectionStart,this.value.length),this.selectionStart=a,this.selectionEnd=a,this.focus(),t.preventDefault?t.preventDefault():t.returnValue=!1,!1}}),addEvent(e,"keyup",function(e){var t,n,r=e||window.event,a=r.keyCode||r.which,o=r.shiftKey||r.ctrlKey||r.metaKey;o||13!==a||(t=new InputState(l),n=t.getChunk(),Command.autoIndent(l,n,function(){t.setChunk(n),t.restore()}))}),browser.IE&&addEvent(e,"keypress",function(e){var t=e||window.event,n=t.keyCode||t.which;return 27===n?(t.returnValue=!1,!1):void 0}),n.preview&&n.previewEvery>0&&"function"==typeof n.showdown&&("string"==typeof n.preview&&(n.preview=document.getElementById(n.preview)),o=setInterval(t,1e3*n.previewEvery),addEvent(e,"keypress",t),addEvent(e,"keydown",t))}n=extend({preview:null,previewEvery:.5,showdown:null,lineLength:40,commands:"strong em a blockquote code img ol ul h hr",commandTable:{},lang:"EN"},n),chooseTranslator(n.lang),"string"==typeof e&&(e=document.getElementById(e)),"string"==typeof t&&(t=document.getElementById(t));var o,l={},i={},s="";return!n.showdown&&"undefined"!=typeof Attacklab&&Attacklab.showdown&&Attacklab.showdown.converter&&(n.showdown=(new Attacklab.showdown.converter).makeHtml),r(),a(),extend(l,{input:e,options:n,ieClicked:!1,ieRange:null})},addEvent(window,"unload",function(){for(;eventCache.length>0;)removeEvent(eventCache[0].element,eventCache[0].event,eventCache[0].callback)}),Translator_EN={urlFieldInsertion:'<span class="note">To add a tool-tip, place it in quotes after the URL (e.g., <strong>http://google.com "Google"</strong>)</span>',linkText:"link text",imageAlt:"image alt",listItem:"List item",strongTitle:"Strong <strong> Ctl+B",emTitle:"Emphasis <em> Ctl+I",aTitle:"Hyperlink <a> Ctl+L",blockquoteTitle:"Blockquote <blockquote> Ctl+Q",codeTitle:"Code Sample <pre><code> Ctl+K",imgTitle:"Image <img> Ctl+G",olTitle:"Numbered List <ol> Ctl+O",ulTitle:"Bulleted List <ul> Ctl+U",hTitle:"Heading <h1>/<h2> Ctl+H",hrTitle:"Horizontal Rule <hr> Ctl+R",strongText:"Bold",emText:"Italic",aText:"Link",blockquoteText:"Blockquote",codeText:"Code",imgText:"Image",olText:"Numbered List",ulText:"Bulleted List",hText:"Heading",hrText:"Horizontal Rule",insertImage:"Insert image",imageURL:"Image URL",enterCodeHere:"enter code here",blockquote:"Blockquote",insertLink:"Insert link",linkURL:"Link URL",submit:"Submit",cancel:"Cancel"},Translator_RU={urlFieldInsertion:'<span class="note">(например, <strong>http://google.com</strong>)</span>',linkText:"название ссылки",imageAlt:"описание картинки",listItem:"текст",strongTitle:"Жирный <strong> Ctl+B",emTitle:"Курсив <em> Ctl+I",aTitle:"Вставить ссылку <a> Ctl+L",blockquoteTitle:"Цитировать <blockquote> Ctl+Q",codeTitle:"Вставить пример кода <pre><code> Ctl+K",imgTitle:"Вставить картинку <img> Ctl+G",olTitle:"Нумерованный список <ol> Ctl+O",ulTitle:"Маркированный список <ul> Ctl+U",hTitle:"Вставить заголовок <h1>/<h2> Ctl+H",hrTitle:"Горизонтальная черта <hr> Ctl+R",strongText:"Bold",emText:"Italic",aText:"Link",blockquoteText:"Blockquote",codeText:"Code",imgText:"Image",olText:"Numbered List",ulText:"Bulleted List",hText:"Heading",hrText:"Horizontal Rule",insertImage:"Вставить картинку",imageURL:"Адрес картинки",enterCodeHere:"вставьте код сдесь",blockquote:"текст цитаты",insertLink:"Вставить ссылку",linkURL:"Ссылка",submit:"Ок",cancel:"Отмена"},Translator=Translator_EN,Chunk=function(e,t,n,r){var a="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",o={};return extend(o,{before:fixEol(e.substring(0,t)),selection:fixEol(e.substring(t,n)),after:fixEol(e.substring(n)),scrollTop:r,startTag:"",endTag:"",addBlankLines:function(e,t,n){var r,a,o;if(e="undefined"==typeof e||null===e?1:e,t="undefined"==typeof t||null===t?1:t,e+=1,t+=1,o=/(^\n*)/.exec(this.selection),this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+(o?o[1]:""),o=/(\n*$)/.exec(this.selection),this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+(o?o[1]:""),o=/(^\n*)/.exec(this.startTag),this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+(o?o[1]:""),o=/(\n*$)/.exec(this.endTag),this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+(o?o[1]:""),this.before){for(r=a="";e>0;)r+="\\n?",a+="\n",e-=1;n&&(r="\\n*"),this.before=this.before.replace(new RegExp(r+"$",""),a)}if(this.after){for(r=a="";t>0;)r+="\\n?",a+="\n",t-=1;n&&(r="\\n*"),this.after=this.after.replace(new RegExp(r,""),a)}return this},setTags:function(e,t){var n,r=this;return e&&(n=extendRegExp(e,"","$"),this.before=this.before.replace(n,function(e){return r.startTag=r.startTag+e,""}),n=extendRegExp(e,"^",""),this.selection=this.selection.replace(n,function(e){return r.startTag=r.startTag+e,""})),t&&(n=extendRegExp(t,"","$"),this.selection=this.selection.replace(n,function(e){return r.endTag=e+r.endTag,""}),n=extendRegExp(t,"^",""),this.after=this.after.replace(n,function(e){return r.endTag=e+r.endTag,""})),this},trimWhitespace:function(e){return this.selection=this.selection.replace(/^(\s*)/,""),e||(this.before=this.before+RegExp.$1),this.selection=this.selection.replace(/(\s*)$/,""),e||(this.after=RegExp.$1+this.after),this},unwrap:function(){var e=new RegExp("([^\\n])\\n(?!(\\n|"+a+"))","g");return this.selection=this.selection.replace(e,"$1 $2"),this},wrap:function(e){var t=new RegExp("(.{1,"+e+"})( +|$\\n?)","gm");return this.unwrap(),this.selection=this.selection.replace(t,function(e,t){return new RegExp("^"+a,"").test(e)?e:t+"\n"}),this.selection=this.selection.replace(/\s+$/,""),this}})},Command=function(e,t,n,r){function a(){o&&(o.className=Command.css.base+" "+t.css)}r=extend({downCssSuffix:"-down"},r);{var o,l={};t.css+r.downCssSuffix}return extend(l,{draw:function(n){var i,s=t.css+r.downCssSuffix;o?n.appendChild(o):(o=document.createElement("li"),o.title=t.title,n.appendChild(o),i=document.createElement("span"),i.innerHTML=t.text,o.appendChild(i),addEvent(o,"click",function(){a(),l.run()}),addEvent(o,"mouseover",function(){a(),addClassName(o,s)}),addEvent(o,"mouseout",function(){a()}),addEvent(o,"mousedown",function(){a(),addClassName(o,Command.css.down),addClassName(o,s),browser.IE&&(e.ieClicked=!0,e.ieRange=document.selection.createRange())})),a()},run:function(){var t=new InputState(e),r=t.getChunk();n(e,r,function(){t.setChunk(r),t.restore()})}})},extend(Command,{css:{base:"wmd-command",over:"wmd-command-over",down:"wmd-command-down"},autoIndent:function(e,t,n,r){r=extend(r,{preventDefaultText:!0}),t.before=t.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n"),t.before=t.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n"),t.before=t.before.replace(/(\n|^)[ \t]+\n$/,"\n\n"),/(\n|^)[ ]{0,3}([*+-])[ \t]+.*\n$/.test(t.before)?Command.runners.ul(e,t,n,extend(r,{preventDefaultText:!1})):/(\n|^)[ ]{0,3}(\d+[.])[ \t]+.*\n$/.test(t.before)?Command.runners.ol(e,t,n,extend(r,{preventDefaultText:!1})):/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(t.before)?Command.runners.blockquote(e,t,n,r):/(\n|^)(\t|[ ]{4,}).*\n$/.test(t.before)?Command.runners.code(e,t,n,r):"function"==typeof n&&n()},create:function(e,t,n){return new Command(e,n,Command.runners[t])},createSpacer:function(e,t,n){var r=null;return{draw:function(e){var t;return r?e.appendChild(r):(r=document.createElement("li"),r.className=Command.css.base+" "+n.css,e.appendChild(r),t=document.createElement("span"),r.appendChild(t)),r},run:function(){}}},createSubmitCancelForm:function(e,t,n){var r=document.createElement("a"),a=new Form(e,{dialog:!0,onSubmit:t,onDestroy:n}),o=new Field("","submit",{value:Translator.submit});return a.addField("submit",o),r.href="javascript:void(0);",r.innerHTML=Translator.cancel,r.onclick=function(){a.destroy()},o.insert("&nbsp;or&nbsp;"),o.insert(r),a},runLinkImage:function(e,t,n,r){function a(e){var n,a;e&&(t.startTag=t.endTag="",n=" [999]: "+e,a=LinkHelper.add(t,n),t.startTag="img"===r.tag?"![":"[",t.endTag="]["+a+"]",t.selection||(t.selection="img"===r.tag?Translator.imageAlt:Translator.linkText))}var n="function"==typeof n?n:function(){};t.trimWhitespace(),t.setTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/),t.endTag.length>1?(t.startTag=t.startTag.replace(/!?\[/,""),t.endTag="",LinkHelper.add(t),n()):/\n\n/.test(t.selection)?(LinkHelper.add(t),n()):"function"==typeof r.prompt?r.prompt(function(e){a(e),n()}):(a(r.link||null),n())},runList:function(e,t,n,r){function a(){var e;return"ol"===r.tag?(e=" "+g+". ",g+=1):e=" "+m+" ",e}function o(e){return void 0===r.tag&&(r.tag=/^\s*\d/.test(e)?"ol":"ul"),e=e.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(){return a()})}var l,i,s,c,u,d=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,f=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,p=!1,m="-",g=1;n="function"==typeof n?n:function(){},t.setTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!t.before||/\n$/.test(t.before)||/^\n/.test(t.startTag)||(t.before=t.before+t.startTag,t.startTag=""),t.startTag&&(l=/\d+[.]/.test(t.startTag),t.startTag="",t.selection=t.selection.replace(/\n[ ]{4}/g,"\n"),t.unwrap(),t.addBlankLines(),l&&(t.after=t.after.replace(f,o)),l&&"ol"===r.tag&&(p=!0)),p||(i=1,t.before=t.before.replace(d,function(e){return/^\s*([*+-])/.test(e)&&(m=RegExp.$1),i=/[^\n]\n\n[^\n]/.test(e)?1:0,o(e)}),t.selection||(t.selection=r.preventDefaultText?" ":Translator.listItem),s=a(),c=1,t.after=t.after.replace(f,function(e){return c=/[^\n]\n\n[^\n]/.test(e)?1:0,o(e)}),t.trimWhitespace(!0),t.addBlankLines(i,c,!0),t.startTag=s,u=s.replace(/./g," "),t.wrap(e.options.lineLength-u.length),t.selection=t.selection.replace(/\n/g,"\n"+u)),n()},runStrongEm:function(e,t,n,r){var a,o,l,i;n="function"==typeof n?n:function(){},extend({stars:2},r),t.trimWhitespace(),t.selection=t.selection.replace(/\n{2,}/g,"\n"),t.before.search(/(\**$)/),a=RegExp.$1,t.after.search(/(^\**)/),o=RegExp.$1,l=Math.min(a.length,o.length),l>=r.stars&&(2!==l||1!==r.stars)?(t.before=t.before.replace(RegExp("[*]{"+r.stars+"}$",""),""),t.after=t.after.replace(RegExp("^[*]{"+r.stars+"}",""),"")):!t.selection&&o?(t.after=t.after.replace(/^([*_]*)/,""),t.before=t.before.replace(/(\s?)$/,""),t.before=t.before+o+RegExp.$1):(t.selection||o||(t.selection=r.text||""),i=r.stars<=1?"*":"**",t.before=t.before+i,t.after=i+t.after),n()},runners:{a:function(e,t,n,r){Command.runLinkImage(e,t,n,extend({tag:"a",prompt:function(e){LinkHelper.createDialog(Translator.insertLink,Translator.linkURL,e)}},r))},blockquote:function(e,t,n,r){function a(e){var n=e?"> ":"";t.startTag&&(t.startTag=t.startTag.replace(/\n((>|\s)*)\n$/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"})),t.endTag&&(t.endTag=t.endTag.replace(/^\n((>|\s)*)\n/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"}))}r=r||{},n="function"==typeof n?n:function(){},t.selection=t.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(e,n,r,a){return t.before+=n,t.after=a+t.after,r}),t.before=t.before.replace(/(>[ \t]*)$/,function(e,n){return t.selection=n+t.selection,""}),t.selection=t.selection.replace(/^(\s|>)+$/,""),t.selection=t.selection||(r.preventDefaultText?"":Translator.blockquote),t.before&&(t.before=t.before.replace(/\n?$/,"\n")),t.after&&(t.after=t.after.replace(/^\n?/,"\n")),t.before=t.before.replace(/(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*$)/,function(e){return t.startTag=e,""}),t.after=t.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(e){return t.endTag=e,""}),/^(?![ ]{0,3}>)/m.test(t.selection)?(t.wrap(e.options.lineLength-2),t.selection=t.selection.replace(/^/gm,"> "),a(!0),t.addBlankLines()):(t.selection=t.selection.replace(/^[ ]{0,3}> ?/gm,""),t.unwrap(),a(!1),!/^(\n|^)[ ]{0,3}>/.test(t.selection)&&t.startTag&&(t.startTag=t.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(t.selection)&&t.endTag&&(t.endTag=t.endTag.replace(/^\n{0,2}/,"\n\n"))),/\n/.test(t.selection)||(t.selection=t.selection.replace(/^(> *)/,function(e,n){return t.startTag=t.startTag+n,""})),n()},code:function(e,t,n,r){r=r||{},n="function"==typeof n?n:function(){};var a=/\S[ ]*$/.test(t.before),o=/^[ ]*\S/.test(t.after),l=1,i=1;!a||o||/\n/.test(t.selection)?(t.before=t.before.replace(/[ ]{4}$/,function(e){return t.selection=e+t.selection,""}),(/\n(\t|[ ]{4,}).*\n$/.test(t.before)||""===t.after||/^\n(\t|[ ]{4,})/.test(t.after))&&(l=0),t.addBlankLines(l,i),t.selection?t.selection=/^[ ]{0,3}\S/m.test(t.selection)?t.selection.replace(/^/gm,"    "):t.selection.replace(/^[ ]{4}/gm,""):(t.startTag="    ",t.selection=r.preventDefaultText?"":Translator.enterCodeHere)):(t.trimWhitespace(),t.setTags(/`/,/`/),t.startTag||t.endTag?t.endTag&&!t.startTag?(t.before=t.before+t.endTag,t.endTag=""):t.startTag=t.endTag="":(t.startTag=t.endTag="`",t.selection||(t.selection=r.preventDefaultText?"":Translator.enterCodeHere))),n()},em:function(e,t,n,r){Command.runStrongEm(e,t,n,extend({stars:1,text:"emphasized text"},r))},h:function(e,t,n,r){r=r||{},n="function"==typeof n?n:function(){};var a,o,l,i=0;if(t.selection=t.selection.replace(/\s+/g," "),t.selection=t.selection.replace(/(^\s+|\s+$)/g,""),t.selection){if(t.setTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(t.startTag)&&(i=RegExp.lastMatch.length),t.startTag=t.endTag="",t.setTags(null,/\s?(-+|=+)/),/=+/.test(t.endTag)?i=1:/-+/.test(t.endTag)&&(i=2),t.startTag=t.endTag="",t.addBlankLines(1,1),a=0===i?2:i-1,a>0)for(o=a>=2?"-":"=",l=t.selection.length,l>e.options.lineLength&&(l=e.options.lineLength),t.endTag="\n";l>0;)t.endTag=t.endTag+o,l-=1}else t.startTag="## ",t.selection="Heading",t.endTag=" ##";n()},hr:function(e,t,n,r){r=r||{},n="function"==typeof n?n:function(){},t.startTag="----------\n",t.selection="",t.addBlankLines(2,1,!0),n()},img:function(e,t,n,r){Command.runLinkImage(e,t,n,extend({tag:"img",prompt:function(e){LinkHelper.createDialog(Translator.insertImage,Translator.imageURL,e)}},r))},ol:function(e,t,n,r){Command.runList(e,t,n,extend({tag:"ol"},r))},strong:function(e,t,n,r){Command.runStrongEm(e,t,n,extend({stars:2,text:"strong text"},r))},ul:function(e,t,n,r){Command.runList(e,t,n,extend({tag:"ul"},r))}}}),Command.builtIn={strong:{text:Translator.strongText,title:Translator.strongTitle,css:"wmd-strong",shortcut:"b"},em:{text:Translator.emText,title:Translator.emTitle,css:"wmd-em",shortcut:"i"},a:{text:Translator.aText,title:Translator.aTitle,css:"wmd-a",shortcut:"l"},blockquote:{text:Translator.blockquoteText,title:Translator.blockquoteTitle,css:"wmd-blockquote",shortcut:"q"},code:{text:Translator.codeText,title:Translator.codeTitle,css:"wmd-code",shortcut:"k"},img:{text:Translator.imgText,title:Translator.imgTitle,css:"wmd-img",shortcut:"g"},ol:{text:Translator.olText,title:Translator.olTitle,css:"wmd-ol",shortcut:"o"},ul:{text:Translator.ulText,title:Translator.ulTitle,css:"wmd-ul",shortcut:"u"},h:{text:Translator.hText,title:Translator.hTitle,css:"wmd-h",shortcut:"h"},hr:{text:Translator.hrText,title:Translator.hrTitle,css:"wmd-hr",shortcut:"r"},spacer:{css:"wmd-spacer",builder:Command.createSpacer}},Dialog=function(e){function t(){r||(e.modal&&(a=new Overlay({color:e.overlayColor,zIndex:e.zIndex-1})),r=document.createElement("div"),document.body.appendChild(r),r.className=e.css,r.style.position="absolute",r.style.zIndex=e.zIndex,r.style.top=(window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop)+(window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight)/2-150+"px",e.insertion&&n.fill(e.insertion),e.closeOnEsc&&addEvent(document,"keypress",function(e){var t=e||window.event,r=t.keyCode||t.which;27===r&&n.destroy()},o))}var n,r,a,o=[],e=extend({zIndex:10,css:"wmd-dialog",overlayColor:"#FFFFFF",modal:!0,closeOnEsc:!0,insertion:null,onDestroy:null},e);return n=extend(n,{destroy:function(){for(;o.length>0;)removeEvent(o[0].element,o[0].event,o[0].callback,o);a&&(a.destroy(),a=null),r&&(r.parentNode.removeChild(r),r=null),"function"==typeof e.onDestroy&&e.onDestroy(this)},fill:function(e){r&&(r.innerHTML="",e=e||"","string"==typeof e?r.innerHTML=e:r.appendChild(e))},hide:function(){r&&(r.style.display="none")},redraw:function(){var e;r&&(e=r.className,r.className="",r.className=e)},show:function(){r&&(r.style.display="")}}),t(),n},Overlay=function(e){function t(){var e,t;r&&(e={left:window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft,top:window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop},t=getViewportDimensions(),r.style.width=t.width+"px",r.style.height=t.height+"px",r.style.left=e.left+"px",r.style.top=e.top+"px",a&&(a.style.width=t.width+"px",a.style.height=t.height+"px",a.style.left=e.left+"px",a.style.top=e.top+"px"))}function n(){r||(r=document.createElement("div"),document.body.appendChild(r),r.style.position="absolute",r.style.background=e.color,r.style.zIndex=e.zIndex,r.style.opacity=e.opacity,browser.IE&&(r.style.filter="progid:DXImageTransform.Microsoft.Alpha(opacity="+100*e.opacity+")",a=document.createElement("iframe"),document.body.appendChild(a),a.frameBorder="0",a.scrolling="no",a.style.position="absolute",a.style.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=0)",a.style.zIndex=e.zIndex-1),e.scroll&&(addEvent(window,"resize",t,l),addEvent(window,"load",t,l),addEvent(window,"scroll",t,l)),t())}var r,a,o={},l=[],e=extend({color:"#FFFFFF",zIndex:9,scroll:!0,opacity:.3},e);return o=extend(o,{destroy:function(){for(;l.length>0;)removeEvent(l[0].element,l[0].event,l[0].callback,l);r&&(r.parentNode.removeChild(r),r=null),a&&(a.parentNode.removeChild(a),a=null)}}),n(),o},Field=function(e,t,n){e=e||"",t=t.toLowerCase(),n=extend({required:!1,inline:!1,"float":!1,items:null,itemsAlign:"left",css:"wmd-field",inputCss:"wmd-fieldinput",buttonCss:"wmd-fieldbutton",passwordCss:"wmd-fieldpassword",labelCss:"wmd-fieldlabel",inlineCss:"wmd-fieldinline",floatCss:"wmd-fieldfloat",errorCss:"wmd-fielderror",reasonCss:"wmd-fieldreason",hiddenCss:"wmd-hidden",value:"",group:"",id:"",insertion:null},n);var r,a,o,l,i,s=[],c=!1;if(indexOf(Field.TYPES,t)<0)throw'"'+t+'" is not a valid field type.';switch(n.id||(n.id=randomString(6,{upper:!1})),r=document.createElement("div"),r.id=n.id,r.className=n.css,n.inline&&addClassName(r,n.inlineCss),n["float"]&&addClassname(r,n.floatCss),"hidden"===t&&addClassName(r,n.hiddenCss),e&&(a=document.createElement("label"),a.className=n.labelCss,a.innerHTML=e,n.required&&(a.innerHTML+=" <em>*</em>"),r.appendChild(a)),o=document.createElement("div"),n.inline&&(o.className=n.inlineCss),r.appendChild(o),i=document.createElement("div"),i.className=n.reasonCss,i.style.display="none",r.appendChild(i),t){case"empty":break;case"checkbox":case"radio":l=Field.createInputList(o,t,n);break;case"select":l=Field.createSelectList(o,t,n),c=!0;break;case"textarea":l=Field.createTextArea(o,t,n),c=!0;break;default:l=Field.createInput(o,t,n),c=!0}return"undefined"==typeof l&&(l=null),a&&c&&a.setAttribute("for",Field.getInputId(n)),extend(r,{addEvent:function(e,n){var a,o,i=function(){n(r)};if(l)switch(t){case"empty":break;case"checkbox":case"radio":for(a=0,o=l.length;o>a;a++)addEvent(l[a],e,i,s);break;default:addEvent(l,e,i,s)}return this},destroy:function(){for(;s.length>0;)removeEvent(s[0].element,s[0].action,s[0].callback,s);return r.parentNode.removeChild(r),this},error:function(e,t){return e?(addClassName(r,n.errorCss),t?(i.innerHTML=t.toString(),i.style.display=""):(i.innerHTML="",i.style.display="none")):(removeClassName(r,n.errorCss),i.style.display="none"),this},focus:function(){return this.isVisible()&&l&&(l.length>0&&("checkbox"===t||"radio"===t)?l[0].focus():l.focus()),this},hide:function(){r.style.display="none"},insert:function(e){e=e||"";var t,n,r;if("string"==typeof e)for(t=document.createElement("div"),t.innerHTML=e,n=0,r=t.childNodes.length;r>n;n++)o.appendChild(t.childNodes[n]);else o.appendChild(e);return this},isRequired:function(){return!!n.required},isVisible:function(){return!r.style.display
},getLabel:function(){return e||""},getType:function(){return t},getValue:function(e){function n(t){var n,r,a;return e&&(n=/^(true)|(false)$/i.exec(t),n?t="undefined"==typeof n[2]||""===n[2]?!0:!1:(r=/^\d*(\.?\d+)?$/.exec(t),r&&r.length>0&&(a="undefined"==typeof r[1]||""===r[1]?parseInt(t,10):parseFloat(t,10),isNaN(a)||(t=a)))),t}var r,a,o;if(l)switch(t){case"empty":break;case"checkbox":for(r=[],a=0,o=l.length;o>a;a++)l[a].checked&&r.push(n(l[a].value));break;case"radio":for(r="",a=0,o=l.length;o>a;a++)if(l[a].checked){r=n(l[a].value);break}break;case"select":r=n(l.options[input.selectedIndex].value);break;default:r=l.value}return r},setValue:function(e){function n(e){return(e||"").toString()===(r?r.value:"")}var r,a,o,i,s,c;if(l)switch(t){case"empty":break;case"checkbox":if("number"==typeof e?e=getArrayFromEnum(e):"string"==typeof e&&(e=[e]),e.length)for(a=0,o=l.length;o>a;a++)for(r=l[a],r.checked="",i=0,s=e.length;s>i;i++)if(n(e[i])){r.checked="checked";break}break;case"radio":for(e=(e||"").toString(),a=0,o=l.length;o>a;a++)l[a].checked="",l[a].value===e&&(l[a].checked="checked");break;case"select":for(e=(e||"").toString(),c=0,a=0,o=l.options.length;o>a;a++)if(l.options[a].value===e){c=a;break}l.selectedIndex=c;break;default:e=(e||"").toString(),l.value=e}return this},show:function(){r.style.display=""}}),n.insertion&&r.insert(n.insertion),r},extend(Field,{TYPES:["button","checkbox","empty","file","hidden","image","password","radio","reset","submit","text","select","textarea"],createInput:function(e,t,n){var r=Field.getInputId(n),a="button"===t||"submit"===t||"reset"===t?n.buttonCss:n.inputCss,o=document.createElement("input");return o.id=r,o.name=r,o.className=a,o.type=t,"password"===t&&n.passwordCss&&addClassName(o,n.passwordCss),o.value=(n.value||"").toString(),e.appendChild(o),o},createInputList:function(e,t,n){var r,a,o,l,i,s,c,u=[];if(n.items&&n.items.length)for(r=0,a=n.items.length;a>r;r++)o=Field.getInputId(n)+"_"+r,l=document.createElement("span"),l.className=n.inputCss,i=document.createElement("label"),i["for"]=o,i.innerHTML=n.items[r].text,s=n.group?n.group:o,c=document.createElement("input"),c.id=o,c.type=t,c.name=s,n.items[r].selected&&(c.checked="checked"),n.items[r].value&&(c.value=n.items[r].value.toString()),"right"===n.itemsAlign?(l.appendChild(c),l.appendChild(document.createTextNode("&nbsp;")),l.appendChild(i)):(l.appendChild(i),l.appendChild(document.createTextNode("&nbsp;")),l.appendChild(c)),e.appendChild(l),u.push(c);return u},createSelectList:function(e,t,n){var r,a,o,l,i=Field.getInputId(n);if(o=document.createElement("select"),o.id=i,o.name=i,o.className=n.inputCss,e.appendChild(o),n.items&&n.items.length){for(l=-1,r=0,a=n.items.length;a>r;r++)o.options[r]=new Option(n.items[r].text,n.items[r].value),n[r].selected&&(l=r);l>-1&&(o.selectedIndex=l)}return o},createTextArea:function(e,t,n){var r=Field.getInputId(n),a=document.createElement("textarea");return a.id=r,a.name=r,a.className=n.inputCss,a.value=(n.value||"").toString(),e.appendChild(a),a},getArrayFromEnum:function(e,t){var n,r=[],a=1;for("string"==typeof e&&(n=parseInt(e,10),e=isNaN(parse)?0:n);e>=a;)(a&e)===a&&(t?r.push(t[a.toString()]):r.push(a)),a=2*a;return r},getEnumFromArray:function(e){var t,n,r,a=0;for(n=0,r=e.length;r>n;n++)t=e[n],"string"==typeof t&&(t=parseInt(t,10),isNaN(t)&&(t=void 0)),"number"==typeof t&&(a|=t);return a},getInputId:function(e){return e.id+"_input"}}),Form=function(e,t){function n(e){var t,n,r=null,a=-1;for(t=0,n=c.length;n>t;t++)if(c[t].key===e){r=c[t].value,a=t;break}return{field:r,index:a}}function r(e){var t,n,r=[];for(t=0,n=c.length;n>t;t++)c[t].key!==e&&r.push(c[t]);c=r}e=e||"",t=extend({css:"wmd-form",legendCss:"wmd-legend",errorCss:"wmd-error",requiredReason:"Required",dialogCss:"wmd-dialog",dialog:!1,modal:!0,dialogZIndex:10,closeOnEsc:!0,id:"",onSubmit:null,onDestroy:null},t);var a,o,l,i,s=[],c=[];return t.id||(t.id=randomString(6,{upper:!1})),a=document.createElement("form"),a.id=t.id,a.className=t.css,a.onsubmit=function(){return"function"==typeof t.onSubmit&&t.onSubmit(a),!1},o=document.createElement("fieldset"),a.appendChild(o),legend=document.createElement("div"),legend.className=t.legendCss,legend.style.display="none",o.appendChild(legend),l=document.createElement("div"),l.className=t.errorCss,l.style.display="none",o.appendChild(l),t.dialog&&(i=new Dialog({modal:t.modal,zIndex:t.dialogZIndex,css:t.dialogCss,closeOnEsc:!1,insertion:a})),addEvent(document,"keypress",function(e){var n=e||window.event,r=n.keyCode||n.which;switch(r){case 27:t.closeOnEsc&&a.destroy()}},s),extend(a,{addField:function(e,t){return this.insertField(-1,e,t)},destroy:function(){var e,n;for("function"==typeof t.onDestroy&&t.onDestroy(this);s.length>0;)removeEvent(s[0].element,s[0].event,s[0].callback,s);for(e=0,n=c.length;n>e;e++)c[e].value&&("function"==typeof c[e].value.destroy?c[e].value.destroy():c[e].value.parentNode&&c[e].value.parentNode.removeChild(c[e].value),c[e].value=null);return c=[],a.parentNode.removeChild(a),a=null,i&&(i.destroy(),i=null),this},error:function(e){return e=(e||"").toString(),l.innerHTML=e,l.style.display=e?"":"none",i&&i.redraw(),this},fill:function(e){var t;if(e)for(t in e)e.hasOwnProperty(t)&&this.setValue(t,e[t]);return this},focus:function(){var e,t;for(e=0,t=c.length;t>e;e++)if(c[e].value&&"function"==typeof c[e].value.focus){c[e].value.focus();break}return this},getDialog:function(){return i},getField:function(e){var t=n(e);return t?t.value:null},getValue:function(e,t){var r=n(e);return r&&r.value&&"function"==typeof r.value.getValue?r.value.getValue(t):void 0},insertField:function(e,t,n){return this.removeField(t),e>=0&&c.length>e?(c.splice(e,0,{key:t,value:n}),c[e+1].value.parentNode.insertBefore(n,c[e+1].value)):(c.push({key:t,value:n}),o.appendChild(n)),i&&i.redraw(),this},removeField:function(e){var t=n(e);return t.value&&("function"==typeof t.value.destroy?t.value.destroy():t.value.parentNode&&t.value.parentNode.removeChild(t.value),r(e)),i&&i.redraw(),this},serialize:function(e,n){var r,a,o,l,s,u={},d=0;for(l=0,s=c.length;s>l;l++)r=c[l].value,a=r.getValue(n),o=r.getType(),"empty"!==o&&"submit"!==o&&"reset"!==o&&"button"!==o&&(""!==a&&"undefined"!=typeof a&&null!==a&&0!==a.length?(u[c[l].key]=a,r.error()):e&&r.isRequired()&&r.isVisible()&&(d+=1,r.error(!0,t.requiredReason)));return i&&i.redraw(),0===d?u:null},setTitle:function(e){return legend.innerHTML=e||"",legend.style.display=e?"":"none",this},setValue:function(e,t){var r=n(e);return r&&r.value&&"function"==typeof r.value.setValue&&r.value.setValue(t),this}}),a.setTitle(e),a},InputState=function(e){var t={},n=e.input;return t=extend(t,{scrollTop:0,text:"",start:0,end:0,getChunk:function(){return new Chunk(this.text,this.start,this.end,this.scrollTop)},restore:function(){this.text!==n.value&&(n.value=this.text),this.setInputSelection(),n.scrollTop=this.scrollTop},setChunk:function(e){e.before=e.before+e.startTag,e.after=e.endTag+e.after,browser.Opera&&(e.before=e.before.replace(/\n/g,"\r\n"),e.selection=e.selection.replace(/\n/g,"\r\n"),e.after=e.after.replace(/\n/g,"\r\n")),this.start=e.before.length,this.end=e.before.length+e.selection.length,this.text=e.before+e.selection+e.after,this.scrollTop=e.scrollTop},setInputSelection:function(){var e;visible(n)&&(n.focus(),n.selectionStart||0===n.selectionStart?(n.selectionStart=this.start,n.selectionEnd=this.end,n.scrollTop=this.scrollTop):document.selection&&(document.activeElement&&document.activeElement!==n||(e=n.createTextRange(),e.moveStart("character",-1*n.value.length),e.moveEnd("character",-1*n.value.length),e.moveEnd("character",this.end),e.moveStart("character",this.start),e.select())))},setStartEnd:function(){var t,r,a,o,l,i="";if(visible(n))if(n.selectionStart||0===n.selectionStart)this.start=n.selectionStart,this.end=n.selectionEnd;else if(document.selection){if(this.text=fixEol(n.value),e.ieClicked&&e.ieRange?(t=e.ieRange,e.ieClicked=!1):t=document.selection.createRange(),r=fixEol(t.text),a=i+r+i,t.text=a,o=fixEol(n.value),t.moveStart("character",-1*a.length),t.text=r,this.start=o.indexOf(i),this.end=o.lastIndexOf(i)-i.length,l=this.text.length-fixEol(n.value).length,l>0){for(t.moveStart("character",-1*r.length);l>0;)r+="\n",this.end=this.end+1,l-=1;t.text=r}this.setInputSelection()}}}),visible(n)&&(n.focus(),t.setStartEnd(),t.scrollTop=n.scrollTop,(n.selectionStart||0===n.selectionStart)&&(t.text=n.value)),t},LinkHelper={add:function(e,t){function n(e){a+=1,e=e.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+a+"]:"),l+="\n"+e}function r(e,t,r,l){var i="";return o[r]?(n(o[r]),i=t+a+l):i=e,i}var a=0,o={},l="",i=/(\[(?:\[[^\]]*\]|[^\[\]])*\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g;return e.before=LinkHelper.strip(e.before,o),e.selection=LinkHelper.strip(e.selection,o),e.after=LinkHelper.strip(e.after,o),e.before=e.before.replace(i,r),t?n(t):e.selection=e.selection.replace(i,r),e.after=e.after.replace(i,r),e.after&&(e.after=e.after.replace(/\n*$/,"")),e.after||(e.selection=e.selection.replace(/\n*$/,"")),e.after=e.after+"\n\n"+l,a},createDialog:function(e,t,n){var r,a,o=!1;n="function"==typeof n?n:function(){},r=Command.createSubmitCancelForm(e,function(){var e=r.serialize(!0);e&&(o=!0,r.destroy(),n(e.url))},function(){o||n("")}),a=new Field(t,"text",{required:!0,value:"http://",insertion:Translator.urlFieldInsertion}),r.insertField(0,"url",a),a.focus()},strip:function(e,t){var n=/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm;return e=e.replace(n,function(e,n,r,a,o){var l="";return t[n]=e.replace(/\s*$/,""),a&&(t[n]=e.replace(/["(](.+?)[")]$/,""),l=a+o),l})}};